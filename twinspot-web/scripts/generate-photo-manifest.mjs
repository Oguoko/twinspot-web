import fs from "node:fs";
import path from "node:path";

const projectRoot = process.cwd();
const photosRoot = path.join(projectRoot, "public", "photos");
const outputPath = path.join(projectRoot, "lib", "photoManifest.ts");

const allowedExtensions = new Set([".jpg", ".jpeg", ".png", ".webp"]);

function getPhotoManifest() {
  if (!fs.existsSync(photosRoot)) {
    return {};
  }

  const folders = fs
    .readdirSync(photosRoot, { withFileTypes: true })
    .filter((entry) => entry.isDirectory())
    .map((entry) => entry.name)
    .sort((a, b) => a.localeCompare(b));

  return folders.reduce((acc, folder) => {
    const folderPath = path.join(photosRoot, folder);
    const files = fs
      .readdirSync(folderPath, { withFileTypes: true })
      .filter((entry) => entry.isFile())
      .map((entry) => entry.name)
      .filter((fileName) => allowedExtensions.has(path.extname(fileName).toLowerCase()))
      .sort((a, b) => a.localeCompare(b));

    acc[folder] = files;
    return acc;
  }, {});
}

const manifest = getPhotoManifest();

const fileContent = `/* AUTO-GENERATED by scripts/generate-photo-manifest.mjs */\n\nexport const PHOTO_MANIFEST = ${JSON.stringify(
  manifest,
  null,
  2
)} as const;\n\nexport type PhotoManifestFolder = keyof typeof PHOTO_MANIFEST;\n`;

fs.writeFileSync(outputPath, fileContent, "utf8");
console.log(`Generated ${path.relative(projectRoot, outputPath)}`);
